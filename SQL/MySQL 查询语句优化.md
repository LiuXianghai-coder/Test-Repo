# MySQL 查询语句优化

## 优化数据访问

查询性能低下最基本的原因是访问的数据太多。特别是有的查询可能不得不筛选大量的数据，但是这种情况不会经常出现。大部分性能低下的查询语句都可以通过减少数据访问量的方式进行优化，一般来讲，通过以下两个方面来分析低效的查询是有效的：

1. 确认应用程序是否在检索大量超过需要的数据，这种情况通常是访问了太多的行，或者访问了太多的列导致的

2. 确认 MySQL 服务器是否在分析大量超过需要的数据行

### 是否请求了不需要的数据

有些查询会请求超过实际需要的数据，然后这些多余的数据会被应用程序丢弃，这其实是不必要的。典型的情况有以下几种：

- 查询不需要的记录
  
  一个常见的错误是常常会误以为 MySQL 只会返回需要的数据，实际上 MySQL 会先返回全部的结果集再进行计算。对于这种情况，在查询的尾部加上 `LIMIT` 子句可能是一个有效的解决方案

- 多表关联时返回全部列
  
  这种情况会返回大量的非必须列，这些列实际上不会被使用，因此查询时需要注意这些，只查询需要的列

- 总是取出全部的列
  
  由于索引的原因，如果总是取出一个表的全部的列可能不得不进行回表查询，因此这可能会降低索引的使用效率。

- 重复查询相同的数据
  
  这种情况一般考虑加入一个缓存中间件来缓存上一次的查询，避免多次的重复查询

### 是否在扫描额外的数据

对于一个 SQL 查询，衡量它的开销主要有以下三个指标：响应时间、扫描的行数、返回的行数。这三个指标都会记录到 MySQL 的慢查询日志中，因此一般检查慢查询日志即可

- 响应时间
  
  响应时间包括两部分时间：服务时间和排队时间。服务时间指的是数据库处理这个查询的时候真正花费了多少时间；排队时间是指服务器因为等待某些资源而没有被真正执行的时间。

- 扫描的行数和返回的行数
  
  理想情况下扫描的行数和返回的行数是一致的，但是这种情况一般不会出现

在评估查询开销的时候，需要考虑一下从表中找到某一行数据的成本。在 MySQL 的 `EXAPLIN` 的 `type` 字段反映了访问类型：全表扫描、范围扫描、唯一索引查询、常数引用等，这里的访问速度从左向右递增。

如果查询没有办法找到合适的访问类型，那么解决的最好办法就是增加一个合适的索引。

在 MySQL 中，如果能够使用如下三种方式来应用 `WHERE` 条件，从好到坏依次为：

- 在索引中应用 `WHERE` 子句中的过滤条件，这些过滤条件可以在索引中完成，而这项任务是在存储引擎层完成的，这样可以最大化提高查询性能

- 使用联合索引来返回记录（在 `Extra` 列中出现了 `using index`），直接从索引中过滤不需要的记录并返回命中的结果，这个操作在 MySQL 的服务层来完成，由于联合索引中存在数据，因此不需要再回表查询

- 从数据表中返回数据，然后过滤不满足条件的记录（在 `Extra` 列中出现 `using where`）。这项操作同样在 MySQL 服务器层实现，MySQL 需要首先从数据表中读取然后再过滤 `WHERE` 条件

如果发现一个查询需要扫描大量的数据但是只是返回少数的行，那么通常可以按照如下的方式优化它：

- 使用联合索引，把需要用到的列都放入到索引中，这样存储引擎就无需回表获取对应的行即可查询到结果

- 改变表的结构，例如使用单独的汇总表

- 重写这个复杂的查询，使得 MySQL 能够以更优化的方式执行这个查询

## 重构查询的方式

在优化有问题的查询时，目标应该是找到一个更优的方法获得实际需要的结果，而不是总是需要从 MySQL 中获取一模一样的结果集。

### 切分查询

有时候将一个大查询分解为多个小查询会是一个很好的选择。比如，在删除旧数据的时候，如果一次性使用大的删除语句进行删除，可能一次需要锁定很多行的数据、阻塞其它查询等；如果将这个删除语句划分为多个较小的查询，可以尽可能地减少对于数据行的影响。

### 分解关联查询

很多高性能的应用都会对关联查询进行分解。简单地，可以对每一个表进行一次单表查询，然后查询结果在应用程序层进行关联（阿里的开发手册就要求禁止三个表以上的关联查询）。

这样做有以下的一些好处：

- 使得缓存的效率更高。很多应用可以方便地缓存单表的查询结果，并且单表查询不需要做额外的笛卡儿积，因此性能更好。

- 将查询分解之后，对于表的影响将会降低。如果是多表查询，那么在查询时可能涉及到锁竞争的问题

- 将关联关系放到应用层，可以提高数据库的可拓展性，对数据库的拆分更加容易

- 可以减少冗余记录的查询。在应用层中做关联查询，意味着对于某条记录应用只需要查询一次，而在数据库中做查询，则可能需要重复地访问一部分数据。

- 更进一步，这样做相当于在应用层中做了哈希关联，而不是使用 MySQL 的嵌套查询关联

## 查询执行的基础

一般来讲，MySQL 执行一个查询时，需要进行如下的流程：

![MySQLpng.png](https://s2.loli.net/2022/04/08/rSIkU8KlAQmvh5s.png)

1. 客户端发送一条查询给服务器

2. 服务器先查询一下缓存，如果命中了缓存，则立刻返回存储在缓存中的结果。否则，进入下一阶段

3. 服务端进行 SQL 解析、预处理再由优化器生成对应的执行计划

4. MySQL 根据优化器生成的执行计划，调用存储引擎的 API 来执行查询

5. 最终 MySQL 将查询到的结果写入到缓存，同时将结果返回给客户端


