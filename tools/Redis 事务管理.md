# Redis 事务管理

`Redis` 提供了五个指令用于处理事务：`MULTI`、`EXEC`、`DISCARD`、`WATCH`、`UNWATCH`，这五个命令是 `Redis` 进行事务处理的基础。

这些指令允许一组命令在一个步骤中执行，其中有两个重要的保证：

- 一个事务中的所有命令都被序列化并按顺序执行。在 Redis 事务的执行过程中该事务服务于另一个客户端发出的请求的情况永远不会发生。这保证了被执行的命令将会被视为一个单独的隔离操作

- 要么处理所有命令，要么不处理任何命令，因此 Redis 事务具备原子性。`EXEC` 命令触发所有的命令在一个事务中执行，因此，如果客户端在调用 `EXEC` 命令之前在事务上下文中失去与服务器的连接，则不会执行任何操作，相反，如果调用 `EXEC` 命令，则执行所有操作。当使用 AOF 的数据持久化方式时，`Redis` 将确保使用一个单独的 `write` 系统调用来讲事务写入到磁盘中。然而，如果 `Redis` 服务崩溃了，或者被系统管理员以一种强硬的方式杀死，这种情况下可能会导致只保存了部分数据。`Redis` 在重启时将检测这个情况，如果出现了错误将会退出。通过 `redis-check-aof` 工具可以修复这个问题，通过移除这一部分的事务数据使得 `Redis` 服务能够重新启动

自 `Redis 2.2` 版本开始，`Redis` 允许对上述两个保证提供额外的保证，通过乐观锁（与 CAS 的方式类似）来实现。



## 具体使用

- `MULTI`、`EXEC`、`DISCARD`
  
  `MULTI` 是 `Redis` 事务的进入点，这个命令执行之后总是返回 “OK”。执行此命令之后，用户可以输入多条命令，而不是执行这行命令，`Redis` 会将这些命令进行排队。所有输入的命令只有在输入 `EXEC` 命令时才会被实际执行；输入 `DISCARD` 命令将会当前事务的命令队列，并且退出当前事务
  
  

- 



参考：

<sup>[1]</sup> https://mp.weixin.qq.com/s/bs5NfSkQlFbFp7KMQ9aLmw