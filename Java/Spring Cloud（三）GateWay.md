# Spring Cloud （三）GateWay

GateWay 即网关，主要的功能是提供一个类似代理的功能，对相关的服务调用进行统一的处理。

## 网关的作用

不存在网关的服务调用，如下图所示：

<img src="https://s2.loli.net/2022/03/07/kjnxcheNgFLuA5z.png" alt="GateWay.png" style="zoom:67%;" />

在这种情况下，由于每个服务之间的 API 都一样，因此客户端进行服务调用的时候就会变得十分复杂；每个服务对于每次的客户端调用都需要进行相同或者类似的处理，增大了系统的冗余；由于每个 Service 使用的编程语言或者协议不一致，因此可能需要对请求进行进一步的适配处理才能够正常调用服务接口

这个问题其实在 《设计模式—可复用面向对象基础》一书中有一个类似的解决方案，通过 Facade（外观）模式，为服务提供一个统一的接口，使得子系统更加容易使用，这个统一的接口就是 GateWay（网关）代表的角色

引入网关之后，服务调用就会变成如下图所示的结构：

<img src="https://s2.loli.net/2022/03/07/rMc9IWO8K2ykxPq.png" alt="GateWay.png" style="zoom:67%;" />

## 网关的应用场景

- 鉴权认证

    客户端身份认证：主要用于判断当前用户是否是一个合法的用户，一般的做法是使用帐号和密码进行验证，对于一些复杂的认证场景，可以通过采用对应的加密算法来实现

    访问权限控制：身份认证和访问权限一般都是互相联系的。当身份认证通过之后，就需要判断当前的用户是否具有权限访问该资源，或者该用户的访问权限是否被限制了

- 灰度发布（金丝雀发布）

    在某些应用场景中，由于软件版本的迭代速度比较快，在这种情况下直接进行版本发布会伴随一定的风险，为了避免这些问题，一般会采用灰度发布的方式实现平滑过度。

    灰度发布时，会将一部分用户流量引入到当前新发布的版本中，假设现在将客户端流量分为了 A、B 两部分，那么 A 将继续使用原来版本的系统，而 B 则会使用较新的版本，通过 B 的反响，在逐步将 A 中的流量移动到新版本中

    由于网关的存在，定义分流规则并进行实际分流将会变得比较简单

## 网关的技术选型

网关最为关键的两部分：请求的转发路由和过滤器，常见的网关的实现方案有：OpenResty，Zuul、GateWay 等

### OpenResty

OpenResty 是由 Nginx 和 Lua 集成的一个高i性能 Web 应用服务器，内部集成了大量的 Lua 库和第三方模块。可以理解为 OpenResty 就是将 Lua 嵌入到了 Nginx 中，在每个 Nginx 的进程中都嵌入了一个 LuaJIT 来执行 Lua 脚本

OpenResty 指令的执行顺序如下所示：

![OpenResty.png](https://s2.loli.net/2022/03/07/YnOjuiS6eNqhrIl.png)

### Zuul

Zuul 是 Netflix 的一个开源服务网关，它的主要功能是路由转发和请求过滤

Zuul 的核心有一系列的过滤器组成，它定义了 4 中标准类型的过滤器，这些会对应请求的整个生命周期

Zuul 的请求过滤如下：

<img src="https://s2.loli.net/2022/03/07/TPq1p9AMZtQnwUV.png" alt="Zuul.png" style="zoom:80%;" />

各个组件说明如下：

- Pre Filters：前置过滤器，请求被路由之前调用，可以用于处理鉴权、限流等
- Routing Filters：路由过滤器，将请求路由到后端的微服务
- Post Filters：后置过滤器，路由过滤器中远程调用结束后被执行，可以用于统计、监控、日志等
- Error Filters：错误过滤器，任意一个过滤器出现异常或者远程服务调用超时都会被调用

Zuul 1.x 采用的是传统的 TPC（Thread Per Connection）的方式来处理请求，也就是说，对于每一个请求，会为这个请求专门分配一个线程来进行处理，直到这个请求处理完成之后再销毁这个线程，这种方式性能较差

Zuul 本身存在的一些性能问题不适合高并发的场景，因此 Spring Cloud 并没有集成 Zuul 作为默认的网关

### GateWay

Sprin Cloud GateWay 是 Spring 官方团队研发的 API 网关技术，它的目的是取代 Zuul 成为微服务提供一个简单高效的 API 网关。

Spring Cloud GateWay 是基于 Reactor 开发的一套网关，Reactor 通过完全非阻塞的方式保证了性能，并且由于 Reactor 线程模型，对于线程的创建与销毁发生的频率都是相当低的



参考

<sup>[1]</sup> https://mp.weixin.qq.com/s/f17POwoG-VJf-WZJjSuymg